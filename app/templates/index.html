<!doctype html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ú—ñ–Ω—ñ–∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫ –ø–æ—Å–ª—É–≥</title>
    <link rel="icon" type="image/png" href="/static/logo-new.png" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      :root {
        --brand: #22C55E;
        --brand-dark: #15803D;
        --bg-soft: #F0FDF4;
        --bg: #FFFFFF;
        --card: #FFFFFF;
        --text: #1f2a37;
        --muted: #4b5563;
        --border: #bbf7d0;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
        color: var(--text);
        background: var(--bg);
        padding-bottom: 84px;
      }
      .container { max-width: 920px; margin: 0 auto; padding: 20px; }
      .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 10px; }
      .welcome-user {
        font-size: 18px;
        font-weight: 600;
        color: var(--text);
      }
      h1 { margin: 0 0 10px; font-size: 28px; }
      .subtitle { color: var(--muted); margin-bottom: 16px; }
      .grid { display: grid; gap: 14px; }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 14px;
        box-shadow: 0 8px 22px rgba(31, 41, 55, 0.08);
      }
      input, textarea, button, select {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        font-size: 15px;
      }
      input, textarea, select { background: #fff; color: var(--text); }
      textarea { min-height: 80px; resize: vertical; }
      button {
        background: var(--brand);
        color: #fff;
        font-weight: 700;
        border: none;
        cursor: pointer;
        border-radius: 14px;
        min-height: 52px;
      }
      button:hover { background: var(--brand-dark); }
      .btn-outline {
        background: #fff;
        color: var(--brand-dark);
        border: 2px solid var(--brand);
      }
      .btn-outline:hover {
        background: var(--bg-soft);
      }
      .task-title { font-size: 19px; font-weight: 700; margin-bottom: 6px; }
      .meta { color: var(--muted); font-size: 14px; margin-bottom: 8px; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .actions { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: end; }
      .btn-secondary { background: #fff; color: var(--brand-dark); border: 1px solid var(--brand); }
      .btn-black { background: #111827; color: #fff; border: 1px solid #111827; }
      .btn-black:hover { background: #000; }
      .small { font-size: 13px; color: var(--muted); margin-top: 8px; }
      .hidden { display: none !important; }
      .tabbar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        border-top: 1px solid var(--border);
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        padding: 10px 12px max(10px, env(safe-area-inset-bottom));
        z-index: 40;
      }
      .tab-btn {
        min-height: 44px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #fff;
        color: var(--brand-dark);
        font-weight: 700;
        font-size: 13px;
      }
      .tab-btn.active {
        background: var(--brand);
        color: #fff;
        border-color: var(--brand);
      }
      .photo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 8px; }
      .photo-grid img { width: 100%; height: 84px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border); }
      .chip { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #eef3f8; color: #31455a; font-size: 12px; margin-right: 6px; }
      .checks { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .check-item { display: flex; align-items: center; gap: 8px; border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; }
      .check-item input { width: auto; margin: 0; }
      .hero-title { margin: 0 0 10px; font-size: 32px; }
      .brand-wrap { display: flex; justify-content: center; margin-bottom: 12px; }
      .brand-logo { max-width: 420px; width: 100%; height: auto; }
      .quick-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .quick-btn { font-size: 18px; }
      .master-card {
        margin-top: 8px;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px;
        background: #fff;
      }
      .master-head { display: grid; grid-template-columns: 56px 1fr auto; gap: 10px; align-items: center; }
      .master-avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid var(--border);
        background: var(--bg-soft);
      }
      .profile-card .master-avatar { width: 82px; height: 82px; }
      .muted { color: var(--muted); }
      .status-badge { display: inline-block; padding: 4px 10px; border-radius: 999px; background: var(--bg-soft); color: var(--brand-dark); font-size: 12px; font-weight: 700; }
      .cabinet-profile {
        display: grid;
        grid-template-columns: 96px 1fr;
        gap: 12px;
        align-items: start;
      }
      .cabinet-photo {
        width: 96px;
        height: 96px;
        border-radius: 12px;
        object-fit: cover;
        border: 1px solid var(--border);
        background: var(--bg-soft);
      }
      .cabinet-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }
      .splash {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 160px;
        gap: 10px;
      }
      .spinner {
        width: 34px;
        height: 34px;
        border: 4px solid #dcfce7;
        border-top-color: var(--brand);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      @media (max-width: 720px) {
        .row { grid-template-columns: 1fr; }
        .actions { grid-template-columns: 1fr; }
        .photo-grid { grid-template-columns: repeat(3, 1fr); }
        .checks { grid-template-columns: 1fr; }
        .quick-grid { grid-template-columns: 1fr; }
        .master-head { grid-template-columns: 56px 1fr; }
        .cabinet-profile { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="top-bar">
        <div id="welcomeUser" class="welcome-user hidden"></div>
      </div>
      <div class="brand-wrap">
        <img class="brand-logo" src="/static/logo-new.png" alt="–ú–∞–π—Å—Ç–µ—ÄGO" />
      </div>
      <h1 class="hero-title">–ü–æ—Å–ª—É–≥–∏ –ø–æ—Ä—É—á</h1>
      <div class="subtitle">–û–±–µ—Ä—ñ—Ç—å, —Ö—Ç–æ –≤–∏</div>

      <section id="authSplash" class="card splash" style="margin-bottom:14px; background:var(--bg-soft)">
        <div id="authSpinner" class="spinner"></div>
        <strong id="authSplashTitle">–ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø—Ä–æ—Ñ—ñ–ª—å...</strong>
        <div id="authSplashSubtitle" class="small">–¶–µ –∑–∞–π–º–µ –∫—ñ–ª—å–∫–∞ —Å–µ–∫—É–Ω–¥</div>
        <button id="authRetryBtn" class="btn-secondary hidden" style="max-width:240px">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑</button>
      </section>

      <section id="landingCard" class="card hidden" style="margin-bottom:14px; background:var(--bg-soft)">
        <div class="grid">
          <button id="startClientBtn">–Ø —à—É–∫–∞—é –ú–∞–π—Å—Ç—Ä–∞</button>
          <button id="startPerformerBtn" class="btn-outline">–Ø –ú–∞–π—Å—Ç–µ—Ä</button>
        </div>
      </section>

      <div id="appContent" class="hidden">
      <section id="homeSection" class="hidden">
        <section id="quickSection" class="card hidden" style="margin-bottom:14px; background:var(--bg-soft)">
          <h3>–©–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑—Ä–æ–±–∏—Ç–∏?</h3>
          <div class="quick-grid">
            <button id="quickPlumber" class="quick-btn">üîß –°–∞–Ω—Ç–µ—Ö–Ω—ñ–∫</button>
            <button id="quickElectric" class="quick-btn">‚ö° –ï–ª–µ–∫—Ç—Ä–∏–∫</button>
            <button id="quickRepair" class="quick-btn">üè† –†–µ–º–æ–Ω—Ç</button>
            <button id="quickOther" class="quick-btn btn-outline">üî® –Ü–Ω—à–µ</button>
          </div>
          <button id="homeCreateCta" style="margin-top:10px">‚ûï –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É</button>
        </section>

        <section id="filtersCard" class="card hidden" style="margin-top:14px; margin-bottom:14px">
          <h3>–ù–æ–≤—ñ –∑–∞—è–≤–∫–∏ –¥–ª—è –≤–∞—Å</h3>
          <div class="grid">
            <div class="row">
              <select id="filterCategory">
                <option value="">–£—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
              </select>
              <input id="filterCity" placeholder="–ú—ñ—Å—Ç–æ/—Ä–∞–π–æ–Ω" />
            </div>
            <div class="row">
              <select id="filterUrgency">
                <option value="">–ë—É–¥—å-—è–∫–∞ —Ç–µ—Ä–º—ñ–Ω–æ–≤—ñ—Å—Ç—å</option>
                <option value="today">–°—å–æ–≥–æ–¥–Ω—ñ</option>
                <option value="1-3days">1-3 –¥–Ω—ñ</option>
                <option value="not_urgent">–ù–µ —Ç–µ—Ä–º—ñ–Ω–æ–≤–æ</option>
              </select>
              <input id="filterMaxBudget" type="number" placeholder="–ë—é–¥–∂–µ—Ç –¥–æ, –≥—Ä–Ω" />
            </div>
            <div class="actions">
              <button id="applyFilters">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏</button>
              <button id="resetFilters" class="btn-secondary">–°–∫–∏–Ω—É—Ç–∏</button>
            </div>
          </div>
        </section>
        <div id="tasks" class="grid"></div>
      </section>

      <section id="registrationCard" class="card hidden">
        <h3>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h3>
        <div class="grid">
          <select id="roleSelect" class="hidden">
            <option value="client">–Ø —à—É–∫–∞—é –ø–æ—Å–ª—É–≥—É</option>
            <option value="performer">–Ø –≤–∏–∫–æ–Ω–∞–≤–µ—Ü—å –ø–æ—Å–ª—É–≥</option>
          </select>
          <input id="firstName" placeholder="–Ü–º'—è" />
          <input id="lastName" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ" />
          <input id="middleName" placeholder="–ü–æ –±–∞—Ç—å–∫–æ–≤—ñ" />
          <input id="phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É" />
          <input id="profileCity" placeholder="–ú—ñ—Å—Ç–æ" list="profileCityOptions" autocomplete="off" />
          <datalist id="profileCityOptions"></datalist>
          <input id="address" placeholder="–ê–¥—Ä–µ—Å–∞ (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)" />
          <div id="performerCategoriesWrap" class="hidden">
            <div class="small" style="margin-bottom:8px">–û–±–µ—Ä—ñ—Ç—å –ø–æ—Å–ª—É–≥–∏, —è–∫—ñ –Ω–∞–¥–∞—î—Ç–µ:</div>
            <div id="performerCategories"></div>
            <div class="small" style="margin-top:10px; margin-bottom:6px">–í–∞—à–µ —Ñ–æ—Ç–æ (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</div>
            <input id="performerPhoto" type="file" accept="image/*" style="margin-top:8px" />
            <div class="small">–î–ª—è –≤–∏–∫–æ–Ω–∞–≤—Ü—è —Ñ–æ—Ç–æ –∞–Ω–∫–µ—Ç–∏ –æ–±–æ–≤'—è–∑–∫–æ–≤–µ.</div>
          </div>
          <button id="registerBtn">–ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é</button>
          <div class="small" id="registerStatus"></div>
          <div class="small">–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å –±—É–¥–µ –±–∞—á–∏—Ç–∏ –ª–∏—à–µ –∑–∞—è–≤–∫–∏ –∑—ñ —Å–≤–æ—ó—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π.</div>
        </div>
      </section>

      <section id="createSection" class="hidden">
        <section id="createTaskCard" class="card hidden">
          <h3>–°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É</h3>
          <div class="grid">
            <input id="title" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ü–æ–ª–∞–≥–æ–¥–∏—Ç–∏ –∫—Ä–∞–Ω" />
            <textarea id="description" placeholder="–û–ø–∏—à—ñ—Ç—å –∑–∞–≤–¥–∞–Ω–Ω—è –¥–µ—Ç–∞–ª—å–Ω—ñ—à–µ"></textarea>
            <div class="small" style="margin-bottom:2px; font-weight:700">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó —Ä–æ–±—ñ—Ç</div>
            <div id="taskCategories" class="checks"></div>
            <div class="row">
              <input id="city" placeholder="–ú—ñ—Å—Ç–æ (–ö–∏—ó–≤)" list="taskCityOptions" autocomplete="off" />
              <datalist id="taskCityOptions"></datalist>
            </div>
            <input id="taskAddress" placeholder="–ê–¥—Ä–µ—Å–∞ (–≤—É–ª–∏—Ü—è, –±—É–¥–∏–Ω–æ–∫) ‚Äî –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ" />
            <select id="taskUrgency">
              <option value="today">–°—å–æ–≥–æ–¥–Ω—ñ</option>
              <option value="1-3days">1-3 –¥–Ω—ñ</option>
              <option value="not_urgent" selected>–ù–µ —Ç–µ—Ä–º—ñ–Ω–æ–≤–æ</option>
            </select>
            <input id="budget" type="number" placeholder="–ë—é–¥–∂–µ—Ç –¥–æ, –≥—Ä–Ω (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)" />
            <input id="photos" type="file" accept="image/*" multiple />
            <div class="small">–ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –¥–æ 3 —Ñ–æ—Ç–æ.</div>
            <button id="createTask">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
          </div>
        </section>
        <section id="createBlockedCard" class="card hidden">
          <h3>–î–æ—Å—Ç—É–ø–Ω–æ –ª–∏—à–µ –¥–ª—è –∫–ª—ñ—î–Ω—Ç—ñ–≤</h3>
          <div class="small">–©–æ–± —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∑–∞—è–≤–∫–∏, —É–≤—ñ–º–∫–Ω—ñ—Ç—å —Ä–æ–ª—å –∫–ª—ñ—î–Ω—Ç–∞.</div>
          <button id="switchToClientBtn" style="margin-top:8px">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ä–æ–ª—å</button>
        </section>
      </section>

      <section id="myRequestsSection" class="hidden">
        <section class="card">
          <h3 id="myRequestsTitle">–ú–æ—ó –∑–∞—è–≤–∫–∏</h3>
          <div id="myRequestsGrid" class="grid"></div>
        </section>
      </section>

      <section id="profileSection" class="hidden" style="margin-top:14px">
        <div id="cabinetCard" class="card hidden" style="margin-bottom:14px"></div>
        <div id="performerProfileCard" class="card hidden profile-card" style="margin-bottom:14px"></div>
      </section>
      </div>
    </div>
    <nav id="tabbar" class="tabbar hidden">
      <button id="tabHome" class="tab-btn">üè† –ì–æ–ª–æ–≤–Ω–∞</button>
      <button id="tabCreate" class="tab-btn">‚ûï –ó–∞—è–≤–∫–∞</button>
      <button id="tabMy" class="tab-btn">üìã –ú–æ—ó –∑–∞—è–≤–∫–∏</button>
      <button id="tabChats" class="tab-btn">üí¨ –ß–∞—Ç–∏</button>
      <button id="tabProfile" class="tab-btn">üë§ –ö–∞–±—ñ–Ω–µ—Ç</button>
    </nav>

    <script>
      const tg = window.Telegram?.WebApp;
      if (tg) {
        tg.ready();
        tg.expand();
      }

      const API_BASE = window.API_BASE_OVERRIDE || window.location.origin;
      let currentUser = null;
      let serviceCategories = [];
      let appStarted = false;
      let selectedRole = "client";
      let activeTab = "home";
      let authState = "loading"; // loading | authed | unauthed
      let authInitInProgress = false;
      const ukraineCitySeed = [
        "–ö–∏—ó–≤","–•–∞—Ä–∫—ñ–≤","–û–¥–µ—Å–∞","–î–Ω—ñ–ø—Ä–æ","–ó–∞–ø–æ—Ä—ñ–∂–∂—è","–õ—å–≤—ñ–≤","–ö—Ä–∏–≤–∏–π –†—ñ–≥","–ú–∏–∫–æ–ª–∞—ó–≤","–í—ñ–Ω–Ω–∏—Ü—è","–•–µ—Ä—Å–æ–Ω",
        "–ü–æ–ª—Ç–∞–≤–∞","–ß–µ—Ä–Ω—ñ–≥—ñ–≤","–ß–µ—Ä–∫–∞—Å–∏","–°—É–º–∏","–ñ–∏—Ç–æ–º–∏—Ä","–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π","–ß–µ—Ä–Ω—ñ–≤—Ü—ñ","–†—ñ–≤–Ω–µ","–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫","–¢–µ—Ä–Ω–æ–ø—ñ–ª—å",
        "–ö—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π","–õ—É—Ü—å–∫","–£–∂–≥–æ—Ä–æ–¥","–ë—ñ–ª–∞ –¶–µ—Ä–∫–≤–∞","–ö—Ä–µ–º–µ–Ω—á—É–∫","–ö–∞–º'—è–Ω—Å—å–∫–µ","–ù—ñ–∫–æ–ø–æ–ª—å","–ë–µ—Ä–¥–∏—á—ñ–≤","–ü–∞–≤–ª–æ–≥—Ä–∞–¥","–ë—Ä–æ–≤–∞—Ä–∏",
        "–ë—É—á–∞","–Ü—Ä–ø—ñ–Ω—å","–í–∏—à–≥–æ—Ä–æ–¥","–ë–æ—Ä–∏—Å–ø—ñ–ª—å","–í–∞—Å–∏–ª—å–∫—ñ–≤","–§–∞—Å—Ç—ñ–≤","–û–±—É—Ö—ñ–≤","–ü–µ—Ä–µ—è—Å–ª–∞–≤",
        "–ë–æ—Ä–∏—Å–ø—ñ–ª—å","–ë–æ—è—Ä–∫–∞","–ë—É—á–∞—á","–ö–æ–Ω–æ—Ç–æ–ø","–®–æ—Å—Ç–∫–∞","–û—Ö—Ç–∏—Ä–∫–∞","–†–æ–º–Ω–∏","–ì–ª—É—Ö—ñ–≤",
        "–ö–æ–≤–µ–ª—å","–ù–æ–≤–æ–≤–æ–ª–∏–Ω—Å—å–∫","–í–æ–ª–æ–¥–∏–º–∏—Ä","–î—É–±–Ω–æ","–í–∞—Ä–∞—à","–°–∞—Ä–Ω–∏","–ú—É–∫–∞—á–µ–≤–æ","–ë–µ—Ä–µ–≥–æ–≤–µ","–•—É—Å—Ç","–¢—è—á—ñ–≤",
        "–°—Ç—Ä–∏–π","–î—Ä–æ–≥–æ–±–∏—á","–°–∞–º–±—ñ—Ä","–ß–µ—Ä–≤–æ–Ω–æ–≥—Ä–∞–¥","–¢—Ä—É—Å–∫–∞–≤–µ—Ü—å","–ë—Ä–æ–¥–∏","–ö–æ–ª–æ–º–∏—è","–ö–∞–ª—É—à","–ù–∞–¥–≤—ñ—Ä–Ω–∞","–Ø—Ä–µ–º—á–µ",
        "–ö–æ—Å—ñ–≤","–ß–æ—Ä—Ç–∫—ñ–≤","–ö—Ä–µ–º–µ–Ω–µ—Ü—å","–ó–±–∞—Ä–∞–∂","–ë–µ—Ä–µ–∂–∞–Ω–∏","–î–æ–ª–∏–Ω–∞","–ë–æ–ª–µ—Ö—ñ–≤","–ù–æ–≤–æ—è–≤–æ—Ä—ñ–≤—Å—å–∫","–ó–æ–ª–æ—á—ñ–≤","–°–æ–∫–∞–ª—å",
        "–ú–∞—Ä—ñ—É–ø–æ–ª—å","–ë–µ—Ä–¥—è–Ω—Å—å–∫","–ú–µ–ª—ñ—Ç–æ–ø–æ–ª—å","–ï–Ω–µ—Ä–≥–æ–¥–∞—Ä","–¢–æ–∫–º–∞–∫","–ü–æ–ª–æ–≥–∏","–ü—Ä–∏–º–æ—Ä—Å—å–∫","–ì—É–ª—è–π–ø–æ–ª–µ","–û—Ä—ñ—Ö—ñ–≤","–í–∞—Å–∏–ª—ñ–≤–∫–∞",
        "–ö–∞—Ö–æ–≤–∫–∞","–ù–æ–≤–∞ –ö–∞—Ö–æ–≤–∫–∞","–ì–µ–Ω—ñ—á–µ—Å—å–∫","–°–∫–∞–¥–æ–≤—Å—å–∫","–û–ª–µ—à–∫–∏","–ì–æ–ª–∞ –ü—Ä–∏—Å—Ç–∞–Ω—å","–ß–∞–ø–ª–∏–Ω–∫–∞","–ë–µ—Ä–∏—Å–ª–∞–≤","–¢–∞–≤—Ä—ñ–π—Å—å–∫","–ì–æ—Ä–Ω–æ—Å—Ç–∞—ó–≤–∫–∞",
        "–Æ–∂–Ω–æ—É–∫—Ä–∞—ó–Ω—Å—å–∫","–ü–µ—Ä–≤–æ–º–∞–π—Å—å–∫","–í–æ–∑–Ω–µ—Å–µ–Ω—Å—å–∫","–ë–∞—à—Ç–∞–Ω–∫–∞","–ù–æ–≤–∞ –û–¥–µ—Å–∞","–°–Ω—ñ–≥—É—Ä—ñ–≤–∫–∞","–û—á–∞–∫—ñ–≤","–ö–æ—Ä–∞–±–µ–ª—å–Ω–µ","–ê—Ä–±—É–∑–∏–Ω–∫–∞","–î–æ–º–∞–Ω—ñ–≤–∫–∞",
        "–Ü–∑–º–∞—ó–ª","–ß–æ—Ä–Ω–æ–º–æ—Ä—Å—å–∫","–ü–æ–¥—ñ–ª—å—Å—å–∫","–ë—ñ–ª–≥–æ—Ä–æ–¥-–î–Ω—ñ—Å—Ç—Ä–æ–≤—Å—å–∫–∏–π","–Æ–∂–Ω–µ","–†–æ–∑–¥—ñ–ª—å–Ω–∞","–¢–∞—Ç–∞—Ä–±—É–Ω–∞—Ä–∏","–ê—Ä—Ü–∏–∑","–†–µ–Ω—ñ","–ë–æ–ª–≥—Ä–∞–¥",
        "–õ—É–±–Ω–∏","–ú–∏—Ä–≥–æ—Ä–æ–¥","–ì–æ—Ä—ñ—à–Ω—ñ –ü–ª–∞–≤–Ω—ñ","–ü–∏—Ä—è—Ç–∏–Ω","–ì–∞–¥—è—á","–ö–∞—Ä–ª—ñ–≤–∫–∞","–†–µ—à–µ—Ç–∏–ª—ñ–≤–∫–∞","–õ–æ—Ö–≤–∏—Ü—è","–ö–æ–±–µ–ª—è–∫–∏","–ó—ñ–Ω—å–∫—ñ–≤",
        "–ö—Ä–∞–º–∞—Ç–æ—Ä—Å—å–∫","–°–ª–æ–≤'—è–Ω—Å—å–∫","–ë–∞—Ö–º—É—Ç","–ü–æ–∫—Ä–æ–≤—Å—å–∫","–ö–æ—Å—Ç—è–Ω—Ç–∏–Ω—ñ–≤–∫–∞","–î—Ä—É–∂–∫—ñ–≤–∫–∞","–î–æ–±—Ä–æ–ø—ñ–ª–ª—è","–õ–∏–º–∞–Ω","–°–µ–ª–∏–¥–æ–≤–µ","–¢–æ—Ä–µ—Ü—å–∫",
        "–ü–∞–≤–ª–æ–≥—Ä–∞–¥","–ù–æ–≤–æ–º–æ—Å–∫–æ–≤—Å—å–∫","–ñ–æ–≤—Ç—ñ –í–æ–¥–∏","–°–∏–Ω–µ–ª—å–Ω–∏–∫–æ–≤–µ","–°–∞–º–∞—Ä","–ü–µ—Ä—à–æ—Ç—Ä–∞–≤–µ–Ω—Å—å–∫","–ú–∞—Ä–≥–∞–Ω–µ—Ü—å","–ü–æ–∫—Ä–æ–≤","–í–µ—Ä—Ö–Ω—å–æ–¥–Ω—ñ–ø—Ä–æ–≤—Å—å–∫","–ê–ø–æ—Å—Ç–æ–ª–æ–≤–µ",
        "–£–º–∞–Ω—å","–°–º—ñ–ª–∞","–ó–æ–ª–æ—Ç–æ–Ω–æ—à–∞","–ö–∞–Ω—ñ–≤","–ö–æ—Ä—Å—É–Ω—å-–®–µ–≤—á–µ–Ω–∫—ñ–≤—Å—å–∫–∏–π","–ó–≤–µ–Ω–∏–≥–æ—Ä–æ–¥–∫–∞","–¢–∞–ª—å–Ω–µ","–®–ø–æ–ª–∞","–ì–æ—Ä–æ–¥–∏—â–µ","–í–∞—Ç—É—Ç—ñ–Ω–µ",
        "–ù—ñ–∂–∏–Ω","–ü—Ä–∏–ª—É–∫–∏","–ë–∞—Ö–º–∞—á","–ù–æ–≤–≥–æ—Ä–æ–¥-–°—ñ–≤–µ—Ä—Å—å–∫–∏–π","–ö–æ—Ä—é–∫—ñ–≤–∫–∞","–ú–µ–Ω–∞","–°–æ—Å–Ω–∏—Ü—è","–ù–æ—Å—ñ–≤–∫–∞","–ë–æ–±—Ä–æ–≤–∏—Ü—è","–û—Å—Ç–µ—Ä",
        "–ö–æ—Ä–æ—Å—Ç–µ–Ω—å","–ó–≤—è–≥–µ–ª—å","–ë–µ—Ä–¥–∏—á—ñ–≤","–ú–∞–ª–∏–Ω","–û–≤—Ä—É—á","–†–∞–¥–æ–º–∏—à–ª—å","–ö–æ—Ä–æ—Å—Ç–∏—à—ñ–≤","–ë–∞—Ä–∞–Ω—ñ–≤–∫–∞","–ß—É–¥–Ω—ñ–≤","–ê–Ω–¥—Ä—É—à—ñ–≤–∫–∞",
        "–ö–∞–º'—è–Ω–µ—Ü—å-–ü–æ–¥—ñ–ª—å—Å—å–∫–∏–π","–®–µ–ø–µ—Ç—ñ–≤–∫–∞","–°—Ç–∞—Ä–æ–∫–æ—Å—Ç—è–Ω—Ç–∏–Ω—ñ–≤","–ù–µ—Ç—ñ—à–∏–Ω","–°–ª–∞–≤—É—Ç–∞","–ö—Ä–∞—Å–∏–ª—ñ–≤","–í–æ–ª–æ—á–∏—Å—å–∫","–î–µ—Ä–∞–∂–Ω—è","–ü–æ–ª–æ–Ω–Ω–µ","–Ü–∑—è—Å–ª–∞–≤",
        "–ö–∞–º'—è–Ω–µ—Ü—å-–ü–æ–¥—ñ–ª—å—Å—å–∫–∏–π","–•–æ—Ç–∏–Ω","–ù–æ–≤–æ–¥–Ω—ñ—Å—Ç—Ä–æ–≤—Å—å–∫","–°—Ç–æ—Ä–æ–∂–∏–Ω–µ—Ü—å","–ö—ñ—Ü–º–∞–Ω—å","–í–∞—à–∫—ñ–≤—Ü—ñ","–ì–µ—Ä—Ü–∞","–°–æ–∫–∏—Ä—è–Ω–∏","–ó–∞—Å—Ç–∞–≤–Ω–∞","–ù–æ–≤–æ—Å–µ–ª–∏—Ü—è"
      ];
      const citySuggestionsCache = new Map();
      let profileCityDebounce = null;
      let taskCityDebounce = null;

      function buildHeaders() {
        const headers = {};
        if (tg?.initData) headers["X-Telegram-Init-Data"] = tg.initData;
        if (tg?.initDataUnsafe?.user) headers["X-Telegram-User"] = JSON.stringify(tg.initDataUnsafe.user);
        return headers;
      }

      function hasAnyRegistration(user) {
        if (Boolean(user?.is_client_registered) || Boolean(user?.is_performer_registered)) return true;
        const inferredClient = Boolean(user?.address && user?.phone && user?.city);
        const inferredPerformer = Boolean(
          (user?.performer_categories || []).length || user?.profile_photo_url
        );
        return inferredClient || inferredPerformer;
      }

      function isRoleRegistered(role) {
        if (role === "client") {
          return Boolean(currentUser?.is_client_registered)
            || Boolean(currentUser?.address && currentUser?.phone && currentUser?.city);
        }
        return Boolean(currentUser?.is_performer_registered)
          || Boolean((currentUser?.performer_categories || []).length || currentUser?.profile_photo_url);
      }

      function currentRoute() {
        const path = location.pathname;
        if (path === "/app" || path === "/register") return path;
        const hashRoute = location.hash.replace("#", "");
        if (hashRoute === "/app" || hashRoute === "/register") return hashRoute;
        return "/register";
      }

      function navigate(route, replace = false) {
        if (route !== "/app" && route !== "/register") return;
        if (replace) history.replaceState({}, "", route);
        else history.pushState({}, "", route);
      }

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      function showAuthSplashError(message) {
        const spinner = document.getElementById("authSpinner");
        const title = document.getElementById("authSplashTitle");
        const subtitle = document.getElementById("authSplashSubtitle");
        const retryBtn = document.getElementById("authRetryBtn");
        spinner.classList.add("hidden");
        title.textContent = "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å";
        subtitle.textContent = message;
        retryBtn.classList.remove("hidden");
      }

      function resetAuthSplashLoading() {
        const spinner = document.getElementById("authSpinner");
        const title = document.getElementById("authSplashTitle");
        const subtitle = document.getElementById("authSplashSubtitle");
        const retryBtn = document.getElementById("authRetryBtn");
        spinner.classList.remove("hidden");
        title.textContent = "–ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø—Ä–æ—Ñ—ñ–ª—å...";
        subtitle.textContent = "–¶–µ –∑–∞–π–º–µ –∫—ñ–ª—å–∫–∞ —Å–µ–∫—É–Ω–¥";
        retryBtn.classList.add("hidden");
      }

      function formatApiError(detail, fallbackText) {
        if (!detail) return fallbackText;
        if (typeof detail === "string") return detail;
        if (Array.isArray(detail)) {
          const first = detail[0];
          if (typeof first === "string") return first;
          if (first?.msg) return first.msg;
          return fallbackText;
        }
        if (detail?.msg) return detail.msg;
        return fallbackText;
      }

      function renderCategoryOptions() {
        const taskWrap = document.getElementById("taskCategories");
        taskWrap.innerHTML = serviceCategories
          .map(
            (c) => `
            <label class="check-item">
              <input type="checkbox" value="${c}" name="task-category" />
              <span>${c}</span>
            </label>
          `
          )
          .join("");
        const filterSelect = document.getElementById("filterCategory");
        filterSelect.innerHTML = `<option value="">–£—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>${serviceCategories
          .map((c) => `<option value="${c}">${c}</option>`)
          .join("")}`;

        const wrap = document.getElementById("performerCategories");
        wrap.className = "checks";
        wrap.innerHTML = serviceCategories
          .map(
            (c) => `
            <label class="check-item">
              <input type="checkbox" value="${c}" name="performer-category" />
              <span>${c}</span>
            </label>
          `
          )
          .join("");
      }

      async function fetchUkraineCitySuggestions(query) {
        const q = (query || "").trim();
        if (!q || q.length < 2) {
          return ukraineCitySeed;
        }
        const cacheKey = q.toLowerCase();
        if (citySuggestionsCache.has(cacheKey)) return citySuggestionsCache.get(cacheKey);
        try {
          const url = new URL("https://nominatim.openstreetmap.org/search");
          url.searchParams.set("q", q);
          url.searchParams.set("countrycodes", "ua");
          url.searchParams.set("format", "jsonv2");
          url.searchParams.set("addressdetails", "1");
          url.searchParams.set("limit", "20");
          const res = await fetch(url.toString(), { headers: { Accept: "application/json" } });
          if (!res.ok) throw new Error("city_suggest_failed");
          const data = await res.json();
          const names = [];
          for (const item of data) {
            const a = item.address || {};
            const name = a.city || a.town || a.village || a.municipality || item.name;
            if (name && !names.includes(name)) names.push(name);
          }
          const merged = [...new Set([...names, ...ukraineCitySeed])].slice(0, 40);
          citySuggestionsCache.set(cacheKey, merged);
          return merged;
        } catch (e) {
          return ukraineCitySeed;
        }
      }

      async function populateCityDatalist(inputId, datalistId) {
        const input = document.getElementById(inputId);
        const datalist = document.getElementById(datalistId);
        if (!input || !datalist) return;
        const cities = await fetchUkraineCitySuggestions(input.value);
        datalist.innerHTML = cities.map((city) => `<option value="${city}"></option>`).join("");
      }

      function setupCityAutocomplete() {
        const profileInput = document.getElementById("profileCity");
        const taskInput = document.getElementById("city");
        profileInput.addEventListener("input", () => {
          if (profileCityDebounce) clearTimeout(profileCityDebounce);
          profileCityDebounce = setTimeout(() => populateCityDatalist("profileCity", "profileCityOptions"), 200);
        });
        profileInput.addEventListener("focus", () => populateCityDatalist("profileCity", "profileCityOptions"));
        taskInput.addEventListener("input", () => {
          if (taskCityDebounce) clearTimeout(taskCityDebounce);
          taskCityDebounce = setTimeout(() => populateCityDatalist("city", "taskCityOptions"), 200);
        });
        taskInput.addEventListener("focus", () => populateCityDatalist("city", "taskCityOptions"));
      }

      async function fetchServiceCategories() {
        const res = await fetch(`${API_BASE}/api/service-categories`);
        if (!res.ok) {
          alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –ø–æ—Å–ª—É–≥");
          return;
        }
        serviceCategories = await res.json();
        renderCategoryOptions();
      }

      function buildTaskFiltersQuery() {
        const params = new URLSearchParams();
        const category = document.getElementById("filterCategory").value.trim();
        const city = document.getElementById("filterCity").value.trim();
        const urgency = document.getElementById("filterUrgency").value.trim();
        const maxBudget = document.getElementById("filterMaxBudget").value.trim();
        if (category) params.set("category", category);
        if (city) params.set("city", city);
        if (urgency) params.set("urgency", urgency);
        if (maxBudget) params.set("max_budget", maxBudget);
        const query = params.toString();
        return query ? `?${query}` : "";
      }

      function setActiveTab(tab) {
        activeTab = tab;
        renderAppSections();
      }

      function renderAppSections() {
        const isRegistered = isRoleRegistered(selectedRole);
        const tabbar = document.getElementById("tabbar");
        tabbar.classList.toggle("hidden", !appStarted || !isRegistered || authState !== "authed");

        const sections = {
          home: document.getElementById("homeSection"),
          create: document.getElementById("createSection"),
          my: document.getElementById("myRequestsSection"),
          chats: document.getElementById("chatsSection"),
          profile: document.getElementById("profileSection"),
        };
        Object.values(sections).forEach((el) => el.classList.add("hidden"));
        if (sections[activeTab]) sections[activeTab].classList.remove("hidden");

        document.querySelectorAll(".tab-btn").forEach((btn) => btn.classList.remove("active"));
        const activeBtnMap = {
          home: "tabHome",
          create: "tabCreate",
          my: "tabMy",
          chats: "tabChats",
          profile: "tabProfile",
        };
        const activeBtnId = activeBtnMap[activeTab];
        if (activeBtnId) document.getElementById(activeBtnId).classList.add("active");

        document.getElementById("quickSection").classList.toggle("hidden", selectedRole !== "client");
        document.getElementById("filtersCard").classList.toggle("hidden", selectedRole !== "performer");
        document.getElementById("createTaskCard").classList.toggle("hidden", selectedRole !== "client");
        document.getElementById("createBlockedCard").classList.toggle("hidden", selectedRole !== "performer");
      }

      async function refreshActiveTabData() {
        if (!isRoleRegistered(selectedRole)) return;
        if (activeTab === "home") {
          await fetchHomeTasks();
          return;
        }
        if (activeTab === "my") {
          await fetchMyRequests();
          return;
        }
        if (activeTab === "profile") {
          await openCabinet(true);
        }
      }

      function showByRole() {
        const splash = document.getElementById("authSplash");
        const welcome = document.getElementById("welcomeUser");
        splash.classList.toggle("hidden", authState !== "loading");
        welcome.classList.add("hidden");
        welcome.textContent = "";
        if (authState === "loading") {
          document.getElementById("appContent").classList.add("hidden");
          document.getElementById("landingCard").classList.add("hidden");
          document.getElementById("tabbar").classList.add("hidden");
          return;
        }

        if (!appStarted) {
          document.getElementById("appContent").classList.add("hidden");
          document.getElementById("landingCard").classList.remove("hidden");
          document.getElementById("tabbar").classList.add("hidden");
          return;
        }
        document.getElementById("appContent").classList.remove("hidden");
        document.getElementById("landingCard").classList.add("hidden");
        const isRegistered = isRoleRegistered(selectedRole);
        document.getElementById("registrationCard").classList.toggle("hidden", isRegistered);
        if (isRegistered && selectedRole === "client") {
          welcome.textContent = `–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ, ${currentUser?.full_name || "–ö–ª—ñ—î–Ω—Ç"}`;
          welcome.classList.remove("hidden");
        }
        if (!isRegistered) {
          document.getElementById("performerProfileCard").classList.add("hidden");
          document.getElementById("cabinetCard").classList.add("hidden");
          if (selectedRole) {
            const roleSelect = document.getElementById("roleSelect");
            roleSelect.value = selectedRole;
            roleSelect.dispatchEvent(new Event("change"));
          }
          document.getElementById("tasks").innerHTML = "";
          document.getElementById("myRequestsGrid").innerHTML = "";
          document.getElementById("tabbar").classList.add("hidden");
          document.getElementById("homeSection").classList.add("hidden");
          document.getElementById("createSection").classList.add("hidden");
          document.getElementById("myRequestsSection").classList.add("hidden");
          document.getElementById("profileSection").classList.add("hidden");
        } else {
          renderAppSections();
          refreshActiveTabData();
        }
      }

      function startRoleFlow(role) {
        console.info("[auth] startRoleFlow role=", role, "authState=", authState);
        appStarted = true;
        selectedRole = role;
        activeTab = "home";
        navigate(authState === "authed" ? "/app" : "/register");
        showByRole();
        const isRegistered = isRoleRegistered(role);
        if (isRegistered) {
          fetchHomeTasks();
        }
      }

      function translateTaskStatus(status) {
        return ({ open: "–û—á—ñ–∫—É—î", in_progress: "–í —Ä–æ–±–æ—Ç—ñ", completed: "–ó–∞–≤–µ—Ä—à–µ–Ω–æ", canceled: "–°–∫–∞—Å–æ–≤–∞–Ω–æ" })[status] || status;
      }

      function translateUrgency(value) {
        return ({ today: "–°—å–æ–≥–æ–¥–Ω—ñ", "1-3days": "1-3 –¥–Ω—ñ", not_urgent: "–ù–µ —Ç–µ—Ä–º—ñ–Ω–æ–≤–æ" })[value] || value;
      }

      function formatDateTime(dtRaw) {
        if (!dtRaw) return "‚Äî";
        const dt = new Date(dtRaw);
        if (Number.isNaN(dt.getTime())) return "‚Äî";
        return dt.toLocaleString("uk-UA");
      }

      function renderCabinetTaskCard(item) {
        const roleStatus = selectedRole === "client"
          ? `–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏: ${translateTaskStatus(item.task_status)}`
          : `–°—Ç–∞—Ç—É—Å –≤—ñ–¥–≥—É–∫—É: ${translateBidStatus(item.bid_status || "pending")}`;
        return `
          <div class="master-card">
            <div><strong>${item.title}</strong></div>
            <div class="small">${item.category} ‚Ä¢ ${item.city} ‚Ä¢ ${item.budget} –≥—Ä–Ω</div>
            <div class="small">${roleStatus}</div>
            ${item.selected_performer_name ? `<div class="small">–ú–∞–π—Å—Ç–µ—Ä: ${item.selected_performer_name}</div>` : ""}
            ${item.selected_price ? `<div class="small">–¶—ñ–Ω–∞: ${item.selected_price} –≥—Ä–Ω</div>` : ""}
            <div class="small">–û–Ω–æ–≤–ª–µ–Ω–æ: ${formatDateTime(item.created_at)}</div>
          </div>
        `;
      }

      async function openCabinet(tabMode = false) {
        const isRegistered = selectedRole === "client"
          ? Boolean(currentUser?.is_client_registered)
          : Boolean(currentUser?.is_performer_registered);
        if (!isRegistered) {
          alert("–°–ø–æ—á–∞—Ç–∫—É –∑–∞–≤–µ—Ä—à—ñ—Ç—å —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é —É –≤–∏–±—Ä–∞–Ω–æ–º—É –∫–∞–±—ñ–Ω–µ—Ç—ñ");
          return;
        }
        const card = document.getElementById("cabinetCard");
        card.classList.remove("hidden");
        document.getElementById("performerProfileCard").classList.add("hidden");
        card.innerHTML = "<h3>–ú—ñ–π –∫–∞–±—ñ–Ω–µ—Ç</h3><div class='small'>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>";
        card.scrollIntoView({ behavior: "smooth", block: "start" });

        const meResp = await fetch(`${API_BASE}/api/me`, { headers: buildHeaders() });
        if (meResp.ok) currentUser = await meResp.json();

        const resp = await fetch(`${API_BASE}/api/cabinet/tasks?mode=${selectedRole}`, { headers: buildHeaders() });
        if (!resp.ok) {
          const err = await resp.json();
          card.innerHTML = `<h3>–ú—ñ–π –∫–∞–±—ñ–Ω–µ—Ç</h3><div class='small'>${formatApiError(err.detail, "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–∞–±—ñ–Ω–µ—Ç")}</div>`;
          return;
        }
        const items = await resp.json();
        const activeItems = items.filter((it) => {
          if (selectedRole === "client") return ["open", "in_progress"].includes(it.task_status);
          return ["pending", "accepted", "sent"].includes(it.bid_status || "pending") && it.task_status !== "completed";
        });
        const completedItems = items.filter((it) => {
          if (selectedRole === "client") return it.task_status === "completed";
          return it.bid_status === "completed" || it.task_status === "completed";
        });
        const archiveItems = items.filter((it) => !activeItems.includes(it) && !completedItems.includes(it));

        const profileLine = selectedRole === "client"
          ? `–ö–ª—ñ—î–Ω—Ç: ${currentUser?.full_name || "‚Äî"}`
          : `–ú–∞–π—Å—Ç–µ—Ä: ${currentUser?.full_name || "‚Äî"}`;
        const categoriesLine = selectedRole === "performer"
          ? `<div class="small">–ü–æ—Å–ª—É–≥–∏: ${(currentUser?.performer_categories || []).join(", ") || "‚Äî"}</div>`
          : "";
        const addressLine = selectedRole === "client"
          ? `<div class="small">–ê–¥—Ä–µ—Å–∞: ${currentUser?.address || "‚Äî"}</div>`
          : "";

        const listsHtml = selectedRole === "client" ? "" : `
          <div style="margin-top:12px"><strong>–ê–∫—Ç–∏–≤–Ω—ñ</strong></div>
          <div class="grid" style="margin-top:6px">
            ${activeItems.length ? activeItems.map(renderCabinetTaskCard).join("") : `<div class="small">–ü–æ–∫–∏ –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤</div>`}
          </div>
          <div style="margin-top:12px"><strong>–ó–∞–≤–µ—Ä—à–µ–Ω—ñ</strong></div>
          <div class="grid" style="margin-top:6px">
            ${completedItems.length ? completedItems.map(renderCabinetTaskCard).join("") : `<div class="small">–ü–æ–∫–∏ –Ω–µ–º–∞—î –∑–∞–≤–µ—Ä—à–µ–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤</div>`}
          </div>
          <div style="margin-top:12px"><strong>–ê—Ä—Ö—ñ–≤</strong></div>
          <div class="grid" style="margin-top:6px">
            ${archiveItems.length ? archiveItems.map(renderCabinetTaskCard).join("") : `<div class="small">–ê—Ä—Ö—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π</div>`}
          </div>
        `;

        card.innerHTML = `
          <div class="row" style="align-items:center">
            <h3 style="margin:0">–ú—ñ–π –∫–∞–±—ñ–Ω–µ—Ç</h3>
            ${tabMode ? "" : `<button id="closeCabinetBtn" class="btn-secondary">–ó–∞–∫—Ä–∏—Ç–∏</button>`}
          </div>
          <div class="card" style="margin-top:10px">
            <div class="cabinet-profile">
              <img id="cabinetProfilePhoto" class="cabinet-photo" src="${currentUser?.profile_photo_url || ""}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é" onerror="this.style.visibility='hidden'" />
              <div>
                <div><strong>${profileLine}</strong></div>
                <div class="small">–¢–µ–ª–µ—Ñ–æ–Ω: ${currentUser?.phone || "‚Äî"}</div>
                <div class="small">–ú—ñ—Å—Ç–æ: ${currentUser?.city || "‚Äî"}</div>
                ${addressLine}
                ${categoriesLine}
                <div class="small" style="margin-top:10px">–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é:</div>
                <div class="row" style="grid-template-columns:1fr auto; margin-top:6px">
                  <input id="cabinetPhotoInput" type="file" accept="image/*" />
                  <button id="uploadCabinetPhotoBtn">–û–Ω–æ–≤–∏—Ç–∏ —Ñ–æ—Ç–æ</button>
                </div>
                <div id="cabinetPhotoStatus" class="small"></div>
              </div>
            </div>
            <div class="cabinet-tabs">
              <span class="chip">–ü—Ä–æ—Ñ—ñ–ª—å</span>
              ${selectedRole === "performer" ? `<span class="chip">–ê–∫—Ç–∏–≤–Ω—ñ</span><span class="chip">–Ü—Å—Ç–æ—Ä—ñ—è</span>` : ""}
            </div>
          </div>
          ${listsHtml}
        `;
        document.getElementById("closeCabinetBtn")?.addEventListener("click", () => {
          card.classList.add("hidden");
          card.innerHTML = "";
        });
        document.getElementById("uploadCabinetPhotoBtn")?.addEventListener("click", async () => {
          const statusNode = document.getElementById("cabinetPhotoStatus");
          const file = document.getElementById("cabinetPhotoInput").files?.[0];
          if (!file) {
            statusNode.textContent = "–û–±–µ—Ä—ñ—Ç—å —Ñ–æ—Ç–æ";
            return;
          }
          const formData = new FormData();
          formData.append("profile_photo", file);
          statusNode.textContent = "–û–Ω–æ–≤–ª–µ–Ω–Ω—è...";
          const r = await fetch(`${API_BASE}/api/me/photo`, {
            method: "POST",
            headers: buildHeaders(),
            body: formData,
          });
          if (!r.ok) {
            const err = await r.json();
            statusNode.textContent = formatApiError(err.detail, "–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Ñ–æ—Ç–æ");
            return;
          }
          currentUser = await r.json();
          statusNode.textContent = "–§–æ—Ç–æ –æ–Ω–æ–≤–ª–µ–Ω–æ";
          const photoNode = document.getElementById("cabinetProfilePhoto");
          if (photoNode) {
            photoNode.src = currentUser.profile_photo_url || "";
            photoNode.style.visibility = "";
          }
        });
      }

      async function fetchMe() {
        const headers = buildHeaders();
        const telegramUser = tg?.initDataUnsafe?.user;
        console.info("[auth] fetchMe start", {
          telegramId: telegramUser?.id || null,
          username: telegramUser?.username || null,
          hasInitData: Boolean(tg?.initData),
        });
        const res = await fetch(`${API_BASE}/api/me`, { headers });
        if (!res.ok) {
          console.warn("[auth] fetchMe failed", res.status);
          return null;
        }
        currentUser = await res.json();
        console.info("[auth] fetchMe ok", {
          telegramId: currentUser?.telegram_id,
          role: currentUser?.role,
          is_client_registered: currentUser?.is_client_registered,
          is_performer_registered: currentUser?.is_performer_registered,
        });
        return currentUser;
      }

      async function initAuthGate() {
        if (authInitInProgress) return;
        authInitInProgress = true;
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –≤—ã–±–æ—Ä —Ä–æ–ª–∏, –±–µ–∑ –±–ª–æ–∫–∏—Ä—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.
        authState = "authed";
        appStarted = false;
        selectedRole = "";
        authLastStatus = "bypass";
        authLastReason = "skip_auth";
        authLastTs = new Date().toISOString();
        authErrorText = "";
        const splash = document.getElementById("authSplash");
        if (splash) splash.classList.add("hidden");
        navigate("/register", true);
        showByRole();
        authInitInProgress = false;
      }

      async function registerUser() {
        const registerStatus = document.getElementById("registerStatus");
        registerStatus.textContent = "";
        const role = selectedRole;
        const firstName = document.getElementById("firstName").value.trim();
        const lastName = document.getElementById("lastName").value.trim();
        const middleName = document.getElementById("middleName").value.trim();
        const fullName = `${lastName} ${firstName} ${middleName}`.replace(/\s+/g, " ").trim();
        const phone = document.getElementById("phone").value.trim();
        const city = document.getElementById("profileCity").value.trim();
        const address = role === "client" ? document.getElementById("address").value.trim() : "";
        const categories = Array.from(document.querySelectorAll("input[name='performer-category']:checked"))
          .map((el) => el.value);
        const performerPhoto = document.getElementById("performerPhoto").files?.[0];

        if (!firstName || !lastName || !middleName) {
          registerStatus.textContent = "–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —ñ–º'—è, –ø—Ä—ñ–∑–≤–∏—â–µ —Ç–∞ –ø–æ –±–∞—Ç—å–∫–æ–≤—ñ";
          return;
        }

        if (role === "performer" && !performerPhoto) {
          registerStatus.textContent = "–î–ª—è –≤–∏–∫–æ–Ω–∞–≤—Ü—è —Ñ–æ—Ç–æ –æ–±–æ–≤'—è–∑–∫–æ–≤–µ";
          return;
        }

        const formData = new FormData();
        formData.append("role", role);
        formData.append("full_name", fullName);
        formData.append("phone", phone);
        formData.append("city", city);
        formData.append("address", address);
        categories.forEach((c) => formData.append("categories", c));
        if (performerPhoto) formData.append("profile_photo", performerPhoto);

        try {
          registerStatus.textContent = "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è...";
          console.log("[register] API_BASE", API_BASE);
          const res = await fetch(`${API_BASE}/api/register`, {
            method: "POST",
            headers: buildHeaders(),
            body: formData,
          });

          const raw = await res.text();
          console.log("[register] status", res.status, "raw", raw);
          if (!res.ok) {
            let errDetail = "–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó";
            try {
              const err = raw ? JSON.parse(raw) : {};
              errDetail = formatApiError(err.detail || err, errDetail);
            } catch (e) {
              /* ignore */
            }
            registerStatus.textContent = errDetail;
            return;
          }

          const data = raw ? JSON.parse(raw) : null;
          currentUser = (data && (data.user || data)) || data;
          authState = "authed";
          appStarted = true;
          registerStatus.textContent = "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ";
          navigate("/app", true);
          showByRole();
          renderAppSections();
          fetchHomeTasks();
        } catch (e) {
          console.error("[register] error", e);
          registerStatus.textContent = `–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ: ${e?.message || ""}`;
        }
      }

      async function fetchHomeTasks() {
        const isRegistered = selectedRole === "client"
          ? Boolean(currentUser?.is_client_registered)
          : Boolean(currentUser?.is_performer_registered);
        if (!isRegistered) return;
        const root = document.getElementById("tasks");
        if (selectedRole === "client") {
          root.innerHTML = "";
          return;
        }
        const query = selectedRole === "performer" ? buildTaskFiltersQuery() : "";
        const modeSep = query ? "&" : "?";
        const res = await fetch(`${API_BASE}/api/tasks${query}${modeSep}mode=${selectedRole}`, { headers: buildHeaders() });
        if (!res.ok) {
          const err = await res.json();
          root.innerHTML = `<div class="card">${formatApiError(err.detail, "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è")}</div>`;
          return;
        }

        const tasks = await res.json();
        root.innerHTML = "";
        if (!tasks.length) {
          root.innerHTML = selectedRole === "performer"
            ? `<div class="card">–ü–æ–∫–∏ –Ω–µ–º–∞—î –Ω–æ–≤–∏—Ö –∑–∞—è–≤–æ–∫ —É –≤–∞—à–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö.</div>`
            : `<div class="card">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é —Ç–∞ —Å—Ç–≤–æ—Ä—ñ—Ç—å –ø–µ—Ä—à—É –∑–∞—è–≤–∫—É.</div>`;
          return;
        }

        for (const task of tasks) {
          const photosHtml = (task.photos || []).length
            ? `<div class="photo-grid">${task.photos.map((u) => `<img src="${u}" alt="–§–æ—Ç–æ –∑–∞–≤–¥–∞–Ω–Ω—è" />`).join("")}</div>`
            : "";
          const budgetText = Number(task.budget || 0) > 0 ? `${task.budget} –≥—Ä–Ω` : "–ó–∞ –¥–æ–º–æ–≤–ª–µ–Ω—ñ—Å—Ç—é";

          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div class="task-title">${task.title}</div>
            <div class="meta">${task.category} ‚Ä¢ ${task.city} ‚Ä¢ ${budgetText} ‚Ä¢ –°—Ç–∞—Ç—É—Å: ${translateTaskStatus(task.status)}</div>
            ${task.urgency ? `<div class="small">–¢–µ—Ä–º—ñ–Ω–æ–≤—ñ—Å—Ç—å: ${translateUrgency(task.urgency)}</div>` : ""}
            ${task.address ? `<div class="small">–ê–¥—Ä–µ—Å–∞: ${task.address}</div>` : ""}
            <div>${task.description}</div>
            ${photosHtml}
            ${selectedRole === "performer" ? `
              <div class="bid-form" style="margin-top:10px">
                ${Number(task.budget || 0) > 0 ? `<button class="agree-budget-btn" data-task-id="${task.id}" style="margin-bottom:8px">‚úÖ –ü–æ–≥–æ–¥–∂—É—é—Å—å –∑ —Ü—ñ–Ω–æ—é (${task.budget} –≥—Ä–Ω)</button>` : ""}
                <div style="font-weight:700; margin-bottom:6px">üí¨ –ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ —Å–≤–æ—é —Ü—ñ–Ω—É</div>
                <input id="price-${task.id}" type="number" placeholder="–í–∞—à–∞ —Ü—ñ–Ω–∞" />
                <button style="margin-top:8px" data-task-id="${task.id}" id="send-proposal-${task.id}">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é</button>
                <button class="btn-black hidden" style="margin-top:8px" data-task-id="${task.id}" id="withdraw-proposal-${task.id}">–í—ñ–¥–º–æ–≤–∏—Ç–∏—Å—å</button>
                <div class="small" id="status-${task.id}"></div>
                <div class="small" id="performer-contact-${task.id}"></div>
              </div>
            ` : ""}
          `;

          if (selectedRole === "performer") {
            const agreeBtn = card.querySelector(".agree-budget-btn");
            agreeBtn?.addEventListener("click", async () => {
              const status = document.getElementById(`status-${task.id}`);
              const resp = await fetch(`${API_BASE}/api/tasks/${task.id}/bids`, {
                method: "POST",
                headers: { ...buildHeaders(), "Content-Type": "application/json" },
                body: JSON.stringify({ price: Number(task.budget || 0), message: "–ü–æ–≥–æ–¥–∂—É—é—Å—å —ñ–∑ –∑–∞—è–≤–ª–µ–Ω–∏–º –±—é–¥–∂–µ—Ç–æ–º" }),
              });
              if (!resp.ok) {
                const err = await resp.json();
                status.textContent = formatApiError(err.detail, "–ü–æ–º–∏–ª–∫–∞");
                return;
              }
              const sendBtn = card.querySelector(`#send-proposal-${task.id}`);
              if (sendBtn) {
                sendBtn.textContent = "–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—é –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ";
                sendBtn.disabled = true;
              }
              await loadPerformerTaskState(task.id, status, card.querySelector(`#performer-contact-${task.id}`));
            });

            const bidButton = card.querySelector(`#send-proposal-${task.id}`);
            bidButton.addEventListener("click", async () => {
              const price = Number(document.getElementById(`price-${task.id}`).value);
              const status = document.getElementById(`status-${task.id}`);

              const resp = await fetch(`${API_BASE}/api/tasks/${task.id}/bids`, {
                method: "POST",
                headers: { ...buildHeaders(), "Content-Type": "application/json" },
                body: JSON.stringify({ price, message: "–ó–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–æ –≤–ª–∞—Å–Ω—É —Ü—ñ–Ω—É" }),
              });

              if (resp.ok) {
                const sendBtn = card.querySelector(`#send-proposal-${task.id}`);
                if (sendBtn) {
                  sendBtn.textContent = "–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—é –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ";
                  sendBtn.disabled = true;
                }
                await loadPerformerTaskState(task.id, status, card.querySelector(`#performer-contact-${task.id}`));
              } else {
                const err = await resp.json();
                status.textContent = formatApiError(err.detail, "–ü–æ–º–∏–ª–∫–∞");
              }
            });
            const withdrawBtn = card.querySelector(`#withdraw-proposal-${task.id}`);
            withdrawBtn?.addEventListener("click", async () => {
              const bidId = withdrawBtn.dataset.bidId;
              const status = document.getElementById(`status-${task.id}`);
              if (!bidId) return;
              const resp = await fetch(`${API_BASE}/api/bids/${bidId}/withdraw`, {
                method: "POST",
                headers: buildHeaders(),
              });
              if (!resp.ok) {
                const err = await resp.json();
                status.textContent = formatApiError(err.detail, "–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–∫–ª–∏–∫–∞—Ç–∏");
                return;
              }
              status.textContent = "–í–∏ –≤—ñ–¥–º–æ–≤–∏–ª–∏—Å—è –≤—ñ–¥ –∑–∞—è–≤–∫–∏";
              withdrawBtn.classList.add("hidden");
              const sendBtn = card.querySelector(`#send-proposal-${task.id}`);
              if (sendBtn) {
                sendBtn.disabled = false;
                sendBtn.textContent = "–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é";
              }
              await loadPerformerTaskState(task.id, status, card.querySelector(`#performer-contact-${task.id}`));
            });
            loadPerformerTaskState(task.id, card.querySelector(`#status-${task.id}`), card.querySelector(`#performer-contact-${task.id}`));
          }

          root.appendChild(card);
        }
      }

      async function fetchMyRequests() {
        const root = document.getElementById("myRequestsGrid");
        root.innerHTML = "<div class='small'>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>";
        if (selectedRole === "client") {
          document.getElementById("myRequestsTitle").textContent = "–ú–æ—ó –∑–∞—è–≤–∫–∏";
          const res = await fetch(`${API_BASE}/api/tasks?mode=client`, { headers: buildHeaders() });
          if (!res.ok) {
            const err = await res.json();
            root.innerHTML = `<div class="small">${formatApiError(err.detail, "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è")}</div>`;
            return;
          }
          const tasks = await res.json();
          if (!tasks.length) {
            root.innerHTML = "<div class='small'>–£ –≤–∞—Å —â–µ –Ω–µ–º–∞—î –∑–∞—è–≤–æ–∫</div>";
            return;
          }
          const activeTasks = tasks.filter((t) => ["open", "in_progress"].includes(t.status));
          const completedTasks = tasks.filter((t) => t.status === "completed");
          const archiveTasks = tasks.filter((t) => !activeTasks.includes(t) && !completedTasks.includes(t));

          root.innerHTML = `
            <div><strong>–ê–∫—Ç–∏–≤–Ω—ñ</strong></div>
            <div id="myClientActive" class="grid"></div>
            <div><strong>–ó–∞–≤–µ—Ä—à–µ–Ω—ñ</strong></div>
            <div id="myClientCompleted" class="grid"></div>
            <div><strong>–ê—Ä—Ö—ñ–≤</strong></div>
            <div id="myClientArchive" class="grid"></div>
          `;

          const renderTaskTo = (containerId, taskList, emptyText) => {
            const container = document.getElementById(containerId);
            if (!taskList.length) {
              container.innerHTML = `<div class='small'>${emptyText}</div>`;
              return;
            }
            for (const task of taskList) {
              const card = document.createElement("div");
              card.className = "master-card";
              const budgetText = Number(task.budget || 0) > 0 ? `${task.budget} –≥—Ä–Ω` : "–ó–∞ –¥–æ–º–æ–≤–ª–µ–Ω—ñ—Å—Ç—é";
              card.innerHTML = `
                <div><strong>${task.title}</strong></div>
                <div class="small">${task.category} ‚Ä¢ ${task.city} ‚Ä¢ ${budgetText}</div>
                <div class="small">–°—Ç–∞—Ç—É—Å: ${translateTaskStatus(task.status)}</div>
                <div class="small" id="bids-${task.id}">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ–π –º–∞–π—Å—Ç—Ä—ñ–≤...</div>
              `;
              container.appendChild(card);
              loadTaskBids(task.id, card.querySelector(`#bids-${task.id}`));
            }
          };

          renderTaskTo("myClientActive", activeTasks, "–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞—è–≤–æ–∫");
          renderTaskTo("myClientCompleted", completedTasks, "–ù–µ–º–∞—î –∑–∞–≤–µ—Ä—à–µ–Ω–∏—Ö –∑–∞—è–≤–æ–∫");
          renderTaskTo("myClientArchive", archiveTasks, "–ê—Ä—Ö—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π");
          return;
        }

        document.getElementById("myRequestsTitle").textContent = "–ú–æ—ó –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó / –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è";
        const res = await fetch(`${API_BASE}/api/cabinet/tasks?mode=performer`, { headers: buildHeaders() });
        if (!res.ok) {
          const err = await res.json();
          root.innerHTML = `<div class="small">${formatApiError(err.detail, "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è")}</div>`;
          return;
        }
        const rows = await res.json();
        if (!rows.length) {
          root.innerHTML = "<div class='small'>–£ –≤–∞—Å —â–µ –Ω–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤</div>";
          return;
        }
        const activeRows = rows.filter((r) => ["pending", "accepted", "sent"].includes(r.bid_status || "pending") && r.task_status !== "completed");
        const completedRows = rows.filter((r) => (r.bid_status === "completed" || r.task_status === "completed"));
        const archiveRows = rows.filter((r) => !activeRows.includes(r) && !completedRows.includes(r));

        const renderRows = (list, emptyText) => (
          list.length
            ? list.map((item) => `
              <div class="master-card">
                <div><strong>${item.title}</strong></div>
                <div class="small">${item.category} ‚Ä¢ ${item.city}</div>
                <div class="small">–°—Ç–∞—Ç—É—Å –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó: ${translateBidStatus(item.bid_status || "sent")}</div>
                <div class="small">–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏: ${translateTaskStatus(item.task_status)}</div>
                ${item.selected_price ? `<div class="small">–í–∞—à–∞ —Ü—ñ–Ω–∞: ${item.selected_price} –≥—Ä–Ω</div>` : ""}
              </div>
            `).join("")
            : `<div class='small'>${emptyText}</div>`
        );

        root.innerHTML = `
          <div><strong>–ê–∫—Ç–∏–≤–Ω—ñ</strong></div>
          <div class="grid">${renderRows(activeRows, "–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ–π")}</div>
          <div><strong>–ó–∞–≤–µ—Ä—à–µ–Ω—ñ</strong></div>
          <div class="grid">${renderRows(completedRows, "–ù–µ–º–∞—î –∑–∞–≤–µ—Ä—à–µ–Ω–∏—Ö")}</div>
          <div><strong>–ê—Ä—Ö—ñ–≤</strong></div>
          <div class="grid">${renderRows(archiveRows, "–ê—Ä—Ö—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π")}</div>
        `;
      }

      async function loadTaskBids(taskId, node) {
        const resp = await fetch(`${API_BASE}/api/tasks/${taskId}/bids?mode=client`, { headers: buildHeaders() });
        if (!resp.ok) {
          node.textContent = "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—ñ–¥–≥—É–∫–∏";
          return;
        }
        const bids = await resp.json();
        if (!bids.length) {
          node.textContent = "–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤";
          return;
        }
        node.innerHTML = bids
          .map((b) => `
            <div class="master-card">
              <div class="master-head">
                <img class="master-avatar" src="${b.performer_photo_url || ""}" alt="–§–æ—Ç–æ –º–∞–π—Å—Ç—Ä–∞" onerror="this.style.visibility='hidden'" />
                <div>
                  <div><strong>–ú–∞–π—Å—Ç–µ—Ä: ${b.performer_name || "–ë–µ–∑ —ñ–º–µ–Ω—ñ"}</strong></div>
                  <div class="small">–†–µ–π—Ç–∏–Ω–≥: ${b.performer_rating ?? 0} ‚Ä¢ –í–∏–∫–æ–Ω–∞–Ω–æ: ${b.performer_completed_jobs ?? 0}</div>
                </div>
                <button class="profile-btn btn-outline" data-performer-id="${b.performer_id}">–ü—Ä–æ—Ñ—ñ–ª—å</button>
              </div>
              <div class="small">${b.price} –≥—Ä–Ω${b.message ? ` ‚Ä¢ ${b.message}` : ""}</div>
              <div class="small">–°—Ç–∞—Ç—É—Å: ${translateBidStatus(b.status)}</div>
              <div class="row" style="margin-top:8px">
                ${b.status === "pending" ? `<button class="accept-bid-btn" data-bid-id="${b.id}">–û–±—Ä–∞—Ç–∏ –º–∞–π—Å—Ç—Ä–∞</button>` : ""}
                ${b.status === "pending" ? `<button class="counter-open-btn btn-secondary" data-bid-id="${b.id}">–ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ —Ü—ñ–Ω—É</button>` : ""}
                ${b.status === "accepted" ? `<button class="complete-bid-btn" data-bid-id="${b.id}">–†–æ–±–æ—Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–∞</button>` : ""}
                ${["pending","accepted"].includes(b.status) ? `<button class="reject-bid-btn btn-black" data-bid-id="${b.id}">–í—ñ–¥–º–æ–≤–∏—Ç–∏—Å—å</button>` : ""}
              </div>
              ${b.status === "pending" ? `
                <div id="counter-wrap-${b.id}" class="hidden" style="margin-top:8px">
                  <input id="counter-price-${b.id}" type="number" placeholder="–ù–æ–≤–∞ —Ü—ñ–Ω–∞" />
                  <input id="counter-message-${b.id}" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä –¥–ª—è –º–∞–π—Å—Ç—Ä–∞ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)" style="margin-top:6px" />
                  <button class="counter-send-btn" data-bid-id="${b.id}" style="margin-top:6px">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ü—ñ–Ω—É</button>
                </div>
              ` : ""}
              ${b.status === "completed" && !b.has_review ? `
                <div class="row" style="margin-top:8px">
                  <select id="rating-${b.id}">
                    <option value="5">5</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option>
                  </select>
                  <input id="review-${b.id}" placeholder="–í–∞—à –≤—ñ–¥–≥—É–∫ –ø—Ä–æ —è–∫—ñ—Å—Ç—å —Ä–æ–±–æ—Ç–∏" />
                </div>
                <button class="review-bid-btn" data-bid-id="${b.id}" style="margin-top:8px">–ó–∞–ª–∏—à–∏—Ç–∏ –æ—Ü—ñ–Ω–∫—É</button>
              ` : ""}
              ${b.has_review ? `<div class="small">–í—ñ–¥–≥—É–∫ –≤–∂–µ –∑–∞–ª–∏—à–µ–Ω–æ</div>` : ""}
            </div>
          `)
          .join("");
        node.querySelectorAll(".profile-btn").forEach((btn) => {
          btn.addEventListener("click", () => openPerformerProfile(btn.dataset.performerId));
        });
        node.querySelectorAll(".accept-bid-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const r = await fetch(`${API_BASE}/api/bids/${btn.dataset.bidId}/accept`, { method: "POST", headers: buildHeaders() });
            if (!r.ok) {
              const err = await r.json();
              alert(formatApiError(err.detail, "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–æ–≥–æ–¥–∏—Ç–∏"));
              return;
            }
            fetchMyRequests();
          });
        });
        node.querySelectorAll(".complete-bid-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const r = await fetch(`${API_BASE}/api/bids/${btn.dataset.bidId}/complete`, { method: "POST", headers: buildHeaders() });
            if (!r.ok) {
              const err = await r.json();
              alert(formatApiError(err.detail, "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–µ—Ä—à–∏—Ç–∏"));
              return;
            }
            fetchMyRequests();
          });
        });
        node.querySelectorAll(".counter-open-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const wrap = document.getElementById(`counter-wrap-${btn.dataset.bidId}`);
            wrap?.classList.toggle("hidden");
          });
        });
        node.querySelectorAll(".counter-send-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const bidId = btn.dataset.bidId;
            const price = Number(document.getElementById(`counter-price-${bidId}`).value);
            const message = document.getElementById(`counter-message-${bidId}`).value.trim() || "–ö–æ–Ω—Ç—Ä–ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è –∫–ª—ñ—î–Ω—Ç–∞";
            const r = await fetch(`${API_BASE}/api/bids/${bidId}/counter`, {
              method: "POST",
              headers: { ...buildHeaders(), "Content-Type": "application/json" },
              body: JSON.stringify({ price, message }),
            });
            if (!r.ok) {
              const err = await r.json();
              alert(formatApiError(err.detail, "–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ü—ñ–Ω—É"));
              return;
            }
            fetchMyRequests();
          });
        });
        node.querySelectorAll(".reject-bid-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const r = await fetch(`${API_BASE}/api/bids/${btn.dataset.bidId}/reject`, {
              method: "POST",
              headers: buildHeaders(),
            });
            if (!r.ok) {
              const err = await r.json();
              alert(formatApiError(err.detail, "–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥—Ö–∏–ª–∏—Ç–∏"));
              return;
            }
            fetchMyRequests();
          });
        });
        node.querySelectorAll(".review-bid-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const bidId = btn.dataset.bidId;
            const rating = Number(document.getElementById(`rating-${bidId}`).value);
            const comment = document.getElementById(`review-${bidId}`).value;
            const r = await fetch(`${API_BASE}/api/bids/${bidId}/review`, {
              method: "POST",
              headers: { ...buildHeaders(), "Content-Type": "application/json" },
              body: JSON.stringify({ rating, comment }),
            });
            if (!r.ok) {
              const err = await r.json();
              alert(formatApiError(err.detail, "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –≤—ñ–¥–≥—É–∫"));
              return;
            }
            fetchMyRequests();
          });
        });
      }

      function translateBidStatus(status) {
        return ({
          pending: "–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ",
          sent: "–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ",
          accepted: "–ü—Ä–∏–π–Ω—è—Ç–æ",
          accepted_by_client: "–ü—Ä–∏–π–Ω—è—Ç–æ",
          completed: "–ó–∞–≤–µ—Ä—à–µ–Ω–æ",
          rejected: "–í—ñ–¥—Ö–∏–ª–µ–Ω–æ",
          withdrawn: "–í—ñ–¥–∫–ª–∏–∫–∞–Ω–æ",
        })[status] || status;
      }

      async function openPerformerProfile(performerId) {
        const r = await fetch(`${API_BASE}/api/performers/${performerId}/profile`, { headers: buildHeaders() });
        if (!r.ok) {
          const err = await r.json();
          alert(formatApiError(err.detail, "–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–∫—Ä–∏—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å"));
          return;
        }
        const p = await r.json();
        const card = document.getElementById("performerProfileCard");
        card.classList.remove("hidden");
        card.innerHTML = `
          <div class="master-head">
            <img class="master-avatar" src="${p.profile_photo_url || ""}" alt="–§–æ—Ç–æ –º–∞–π—Å—Ç—Ä–∞" onerror="this.style.visibility='hidden'" />
            <div>
              <h3 style="margin:0">${p.full_name || "–ú–∞–π—Å—Ç–µ—Ä"}</h3>
              <div class="muted">${p.city || ""}</div>
              <div class="small">–†–µ–π—Ç–∏–Ω–≥: ${p.rating_avg} ‚Ä¢ –í–∏–∫–æ–Ω–∞–Ω–æ —Ä–æ–±—ñ—Ç: ${p.completed_jobs}</div>
            </div>
            <button class="btn-secondary" id="closeProfileBtn">–ó–∞–∫—Ä–∏—Ç–∏</button>
          </div>
          <div class="small">–ü–æ—Å–ª—É–≥–∏: ${(p.categories || []).join(", ")}</div>
          <div style="margin-top:8px"><strong>–í—ñ–¥–≥—É–∫–∏:</strong></div>
          <div class="small">${(p.reviews || []).length ? p.reviews.map((rv) => `‚Ä¢ ${rv.rating}/5 ‚Äî ${rv.comment}`).join("<br/>") : "–ü–æ–∫–∏ —â–æ –≤—ñ–¥–≥—É–∫—ñ–≤ –Ω–µ–º–∞—î"}</div>
        `;
        document.getElementById("closeProfileBtn").addEventListener("click", () => {
          card.classList.add("hidden");
          card.innerHTML = "";
        });
      }

      async function loadPerformerTaskState(taskId, statusNode, contactNode) {
        const resp = await fetch(`${API_BASE}/api/tasks/${taskId}/bids?mode=performer`, { headers: buildHeaders() });
        if (!resp.ok) return;
        const bids = await resp.json();
        const card = statusNode?.closest(".card");
        const sendBtn = card?.querySelector(`#send-proposal-${taskId}`);
        const withdrawBtn = card?.querySelector(`#withdraw-proposal-${taskId}`);
        if (!bids.length) {
          if (sendBtn) {
            sendBtn.disabled = false;
            sendBtn.textContent = "–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é";
          }
          withdrawBtn?.classList.add("hidden");
          return;
        }
        const myBid = bids[0];
        statusNode.textContent = `–ú—ñ–π –≤—ñ–¥–≥—É–∫: ${translateBidStatus(myBid.status)} (${myBid.price} –≥—Ä–Ω)`;
        if (sendBtn && myBid.status !== "withdrawn") {
          sendBtn.disabled = true;
          sendBtn.textContent = "–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—é –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ";
        }
        if (withdrawBtn && myBid.status !== "completed" && myBid.status !== "withdrawn") {
          withdrawBtn.dataset.bidId = String(myBid.id);
          withdrawBtn.classList.remove("hidden");
        } else {
          withdrawBtn?.classList.add("hidden");
        }
        if (myBid.status === "accepted" || myBid.status === "completed") {
          const contactResp = await fetch(`${API_BASE}/api/bids/${myBid.id}/client-contact`, { headers: buildHeaders() });
          if (contactResp.ok) {
            const c = await contactResp.json();
            contactNode.innerHTML = `–ö–æ–Ω—Ç–∞–∫—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞: ${c.full_name || ""}, ${c.phone || ""}, ${c.city || ""}, ${c.address || ""}`;
          }
        }
      }

      async function createTask() {
        const files = Array.from(document.getElementById("photos").files || []);
        const selectedTaskCategories = Array.from(document.querySelectorAll("input[name='task-category']:checked"))
          .map((el) => el.value);
        if (!selectedTaskCategories.length) {
          alert("–û–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—é —Ä–æ–±—ñ—Ç");
          return;
        }
        if (files.length > 3) {
          alert("–ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –º–∞–∫—Å–∏–º—É–º 3 —Ñ–æ—Ç–æ");
          return;
        }
        const budgetRaw = document.getElementById("budget").value.trim();
        for (const category of selectedTaskCategories) {
          const formData = new FormData();
          formData.append("title", document.getElementById("title").value);
          formData.append("description", document.getElementById("description").value);
          formData.append("category", category);
          formData.append("city", document.getElementById("city").value);
          formData.append("address", document.getElementById("taskAddress").value);
          formData.append("urgency", document.getElementById("taskUrgency").value);
          formData.append("budget", budgetRaw || "0");
          files.forEach((f) => formData.append("photos", f));

          const res = await fetch(`${API_BASE}/api/tasks`, {
            method: "POST",
            headers: buildHeaders(),
            body: formData,
          });

          if (!res.ok) {
            const err = await res.json();
            alert(formatApiError(err.detail, "–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è"));
            return;
          }
        }

        document.getElementById("title").value = "";
        document.getElementById("description").value = "";
        document.getElementById("city").value = "";
        document.getElementById("taskAddress").value = "";
        document.getElementById("taskUrgency").value = "not_urgent";
        document.getElementById("budget").value = "";
        document.getElementById("photos").value = "";
        document.querySelectorAll("input[name='task-category']").forEach((el) => { el.checked = false; });
        setActiveTab("my");
        fetchMyRequests();
      }

      document.getElementById("roleSelect").addEventListener("change", (e) => {
        const isPerformer = e.target.value === "performer";
        document.getElementById("performerCategoriesWrap").classList.toggle("hidden", !isPerformer);
        const addressInput = document.getElementById("address");
        addressInput.classList.toggle("hidden", isPerformer);
        if (!isPerformer) addressInput.placeholder = "–ê–¥—Ä–µ—Å–∞ (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)";
      });
      document.getElementById("roleSelect").dispatchEvent(new Event("change"));
      document.getElementById("startClientBtn").addEventListener("click", () => startRoleFlow("client"));
      document.getElementById("startPerformerBtn").addEventListener("click", () => startRoleFlow("performer"));
      document.getElementById("registerBtn").addEventListener("click", registerUser);
      document.getElementById("createTask").addEventListener("click", createTask);
      document.getElementById("applyFilters").addEventListener("click", fetchHomeTasks);
      document.getElementById("resetFilters").addEventListener("click", () => {
        document.getElementById("filterCategory").value = "";
        document.getElementById("filterCity").value = "";
        document.getElementById("filterUrgency").value = "";
        document.getElementById("filterMaxBudget").value = "";
        fetchHomeTasks();
      });
      document.getElementById("homeCreateCta").addEventListener("click", () => {
        setActiveTab("create");
      });
      document.getElementById("switchToClientBtn").addEventListener("click", () => {
        selectedRole = "client";
        activeTab = "home";
        showByRole();
        fetchHomeTasks();
      });
      document.getElementById("quickPlumber").addEventListener("click", () => {
        setActiveTab("create");
        document.querySelectorAll("input[name='task-category']").forEach((el) => {
          el.checked = el.value === "–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞";
        });
      });
      document.getElementById("quickElectric").addEventListener("click", () => {
        setActiveTab("create");
        document.querySelectorAll("input[name='task-category']").forEach((el) => {
          el.checked = el.value === "–≠–ª–µ–∫—Ç—Ä–∏–∫–∞";
        });
      });
      document.getElementById("quickRepair").addEventListener("click", () => {
        setActiveTab("create");
        document.querySelectorAll("input[name='task-category']").forEach((el) => {
          el.checked = el.value === "–ú–∞–ª—è—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã";
        });
      });
      document.getElementById("quickOther").addEventListener("click", () => {
        setActiveTab("create");
        document.querySelectorAll("input[name='task-category']").forEach((el) => {
          el.checked = el.value === "–Ü–Ω—à–µ";
        });
      });
      document.getElementById("tabHome").addEventListener("click", () => {
        setActiveTab("home");
        fetchHomeTasks();
      });
      document.getElementById("tabCreate").addEventListener("click", () => setActiveTab("create"));
      document.getElementById("tabMy").addEventListener("click", () => {
        setActiveTab("my");
        fetchMyRequests();
      });
      document.getElementById("tabProfile").addEventListener("click", () => {
        setActiveTab("profile");
        openCabinet(true);
      });
      document.getElementById("authRetryBtn").addEventListener("click", initAuthGate);

      window.addEventListener("popstate", () => {
        if (authState === "authed" && currentRoute() === "/register") {
          navigate("/app", true);
          return;
        }
        if (authState === "unauthed" && currentRoute() === "/app") {
          navigate("/register", true);
        }
      });

      (async () => {
        await fetchServiceCategories();
        setupCityAutocomplete();
        await initAuthGate();
      })();
    </script>
  </body>
</html>
